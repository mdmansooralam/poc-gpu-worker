steps:
- name: gcr.io/cloud-builders/docker
  args:
    ["build","-t","us-central1-docker.pkg.dev/$PROJECT_ID/workers/gpu-worker:worker4-$COMMIT_SHA","."]

- name: gcr.io/cloud-builders/docker
  args:
    ["push","us-central1-docker.pkg.dev/$PROJECT_ID/workers/gpu-worker:worker4-$COMMIT_SHA"]

- name: gcr.io/google.com/cloudsdktool/cloud-sdk
  entrypoint: gcloud
  args:
    [
      "run","deploy","worker4",
      "--image","us-central1-docker.pkg.dev/$PROJECT_ID/workers/gpu-worker:worker4-$COMMIT_SHA",
      "--region","us-central1",
      "--concurrency","1",
      "--max-instances","1",
      "--no-allow-unauthenticated",
      "--set-env-vars","WORKER_ID=worker4,WORKER_TYPE=batch,GPU=L4"
    ]
